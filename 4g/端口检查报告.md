# 4Gè¯­éŸ³åŠ©æ‰‹é¡¹ç›®ç«¯å£æ£€æŸ¥æŠ¥å‘Š

## é¡¹ç›®ç»„ä»¶æ¦‚è¿°

### 1. ESP32ç«¯ (4G/4G.ino)
- **è®¾å¤‡ç±»å‹**: 4Gæ¨¡å—ESP32
- **è¿æ¥ç›®æ ‡**: äº‘æœåŠ¡å™¨
- **ä¸»è¦åŠŸèƒ½**: å½•éŸ³ä¸Šä¼ ã€éŸ³é¢‘æ’­æ”¾

### 2. PCç«¯ (recive_ble.py)
- **è®¾å¤‡ç±»å‹**: PCè“ç‰™æ‰«æå™¨
- **è¿æ¥ç›®æ ‡**: äº‘æœåŠ¡å™¨
- **ä¸»è¦åŠŸèƒ½**: BLEè®¾å¤‡æ‰«æã€ä½ç½®ä¿¡æ¯ä¸Šä¼ 

### 3. äº‘æœåŠ¡å™¨ç«¯ (main/ç›®å½•)
- **æœåŠ¡æ¶æ„**: å¾®æœåŠ¡æ¶æ„
- **ä¸»è¦åŠŸèƒ½**: è¯­éŸ³å¤„ç†ã€AIå¯¹è¯ã€æœåŠ¡åè°ƒ

---

## ç«¯å£é…ç½®è¯¦ç»†åˆ†æ

### ESP32ç«¯é…ç½®
```cpp
const char* serverIP = "124.223.102.137";  // äº‘æœåŠ¡å™¨IP
const int sessionPort = 8083;  // input_serviceç«¯å£ï¼ˆéŸ³é¢‘ä¸Šä¼ ï¼‰
const int apiPort = 8000;      // main_serviceç«¯å£ï¼ˆAPIè°ƒç”¨ï¼‰
```

### PCç«¯é…ç½®
```python
CLOUD_SERVER_URL = "http://124.223.102.137:8000/api/ble/location"
æœ¬åœ°HTTPæœåŠ¡å™¨ç«¯å£: 8080
```

### äº‘æœåŠ¡å™¨ç«¯é…ç½®

#### 1. ä¸»æœåŠ¡ (main.py)
- **ç«¯å£**: 8000
- **åŠŸèƒ½**: ä¸»æ§åˆ¶å™¨ã€4Gåè®®å¤„ç†ã€BLEæ•°æ®æ¥æ”¶
- **å…³é”®æ¥å£**:
  - `/api/4g/session_start` - 4Gè®¾å¤‡ä¼šè¯å¼€å§‹
  - `/api/4g/request_audio` - 4Gè®¾å¤‡éŸ³é¢‘è¯·æ±‚
  - `/api/4g/interrupt` - 4Gè®¾å¤‡ä¸­æ–­æ’­æ”¾
  - `/api/ble/location` - BLEä½ç½®æ•°æ®æ¥æ”¶

#### 2. è¾“å…¥æœåŠ¡ (input_service.py)
- **HTTPç«¯å£**: 8087 (å¥åº·æ£€æŸ¥ã€å…ƒæ•°æ®å¤„ç†)
- **Socketç«¯å£**: 8083 (ESP32éŸ³é¢‘æ•°æ®æ¥æ”¶)
- **åŠŸèƒ½**: æ¥æ”¶ESP32éŸ³é¢‘æµã€è½¬æ¢æ ¼å¼

#### 3. ASRæœåŠ¡ (asr_service.py)
- **ç«¯å£**: 8081
- **åŠŸèƒ½**: è¯­éŸ³è½¬æ–‡å­—

#### 4. LLMæœåŠ¡ (llm_service.py)
- **ç«¯å£**: 8082
- **åŠŸèƒ½**: AIå¯¹è¯å¤„ç†

#### 5. TTSæœåŠ¡ (tts_service.py)
- **ç«¯å£**: 8085
- **åŠŸèƒ½**: æ–‡å­—è½¬è¯­éŸ³

#### 6. ä¸Šä¼ æœåŠ¡ (upload_service.py)
- **ç«¯å£**: 8086
- **åŠŸèƒ½**: éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ å¤„ç†

---

## ç«¯å£åŒ¹é…éªŒè¯

### âœ… æ­£ç¡®åŒ¹é…çš„ç«¯å£

1. **ESP32 â†’ Input Service**
   - ESP32: `sessionPort = 8083`
   - Input Service: `PORT = 8083` (SocketæœåŠ¡)
   - **çŠ¶æ€**: âœ… åŒ¹é…æ­£ç¡®

2. **ESP32 â†’ Main Service**
   - ESP32: `apiPort = 8000`
   - Main Service: è¿è¡Œåœ¨ç«¯å£8000
   - **çŠ¶æ€**: âœ… åŒ¹é…æ­£ç¡®

3. **PCç«¯ â†’ Main Service**
   - PCç«¯: `http://124.223.102.137:8000/api/ble/location`
   - Main Service: ç«¯å£8000ï¼Œå­˜åœ¨è¯¥APIæ¥å£
   - **çŠ¶æ€**: âœ… åŒ¹é…æ­£ç¡®

4. **å†…éƒ¨æœåŠ¡é€šä¿¡**
   ```python
   SERVICE_CONFIG = {
       "asr": "http://localhost:8081",     # âœ… asr_service.py
       "llm": "http://localhost:8082",     # âœ… llm_service.py
       "tts": "http://localhost:8085",     # âœ… tts_service.py
       "upload": "http://localhost:8086",  # âœ… upload_service.py
       "input": "http://localhost:8087"    # âœ… input_service.py HTTPç«¯å£
   }
   ```

### ğŸ” æ¶æ„è¯´æ˜

Input Serviceé‡‡ç”¨åŒç«¯å£è®¾è®¡ï¼š
- **8083ç«¯å£**: SocketæœåŠ¡ï¼Œæ¥æ”¶ESP32çš„éŸ³é¢‘æµæ•°æ®
- **8087ç«¯å£**: HTTPæœåŠ¡ï¼Œä¾›mainæœåŠ¡è¿›è¡Œå¥åº·æ£€æŸ¥å’Œå…ƒæ•°æ®é€šä¿¡

è¿™ç§è®¾è®¡æ˜¯åˆç†çš„ï¼Œå› ä¸ºï¼š
- éŸ³é¢‘æµéœ€è¦é«˜æ•ˆçš„Socketè¿æ¥
- æœåŠ¡ç®¡ç†éœ€è¦æ ‡å‡†çš„HTTPæ¥å£

---

## äº‘æœåŠ¡å™¨é˜²ç«å¢™é…ç½®

### ğŸ”¥ å¿…é¡»å¼€æ”¾çš„ç«¯å£

#### å¯¹å¤–å¼€æ”¾ç«¯å£
```bash
# ä¸»æœåŠ¡ç«¯å£ - ESP32å’ŒPCç«¯éƒ½éœ€è¦è¿æ¥
8000/tcp  # main.py - ä¸»è¦APIå…¥å£

# ESP32éŸ³é¢‘ä¸Šä¼ ç«¯å£
8083/tcp  # input_service.py SocketæœåŠ¡ - ESP32éŸ³é¢‘æµä¸Šä¼ 
```

#### å†…éƒ¨æœåŠ¡ç«¯å£ (å»ºè®®å¼€æ”¾ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•)
```bash
8081/tcp  # asr_service.py - è¯­éŸ³è¯†åˆ«æœåŠ¡
8082/tcp  # llm_service.py - AIå¯¹è¯æœåŠ¡  
8085/tcp  # tts_service.py - è¯­éŸ³åˆæˆæœåŠ¡
8086/tcp  # upload_service.py - æ–‡ä»¶ä¸Šä¼ æœåŠ¡
8087/tcp  # input_service.py HTTPæœåŠ¡ - å¥åº·æ£€æŸ¥
```

### ğŸ›¡ï¸ é˜²ç«å¢™é…ç½®å‘½ä»¤

#### Ubuntu/Debian (ä½¿ç”¨ufw)
```bash
# å¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 8000/tcp comment "Main Service - ESP32&PC"
sudo ufw allow 8083/tcp comment "Input Service Socket - ESP32 Audio"

# å¼€æ”¾å†…éƒ¨æœåŠ¡ç«¯å£ï¼ˆå¯é€‰ï¼Œå»ºè®®å¼€æ”¾ï¼‰
sudo ufw allow 8081/tcp comment "ASR Service"
sudo ufw allow 8082/tcp comment "LLM Service"
sudo ufw allow 8085/tcp comment "TTS Service"
sudo ufw allow 8086/tcp comment "Upload Service"
sudo ufw allow 8087/tcp comment "Input Service HTTP"

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status numbered
```

#### CentOS/RHEL (ä½¿ç”¨firewalld)
```bash
# å¼€æ”¾å¿…è¦ç«¯å£
sudo firewall-cmd --permanent --add-port=8000/tcp --comment="Main Service"
sudo firewall-cmd --permanent --add-port=8083/tcp --comment="Input Socket"

# å¼€æ”¾å†…éƒ¨æœåŠ¡ç«¯å£
sudo firewall-cmd --permanent --add-port=8081/tcp --comment="ASR Service"
sudo firewall-cmd --permanent --add-port=8082/tcp --comment="LLM Service"
sudo firewall-cmd --permanent --add-port=8085/tcp --comment="TTS Service"
sudo firewall-cmd --permanent --add-port=8086/tcp --comment="Upload Service"
sudo firewall-cmd --permanent --add-port=8087/tcp --comment="Input HTTP"

# é‡è½½é…ç½®
sudo firewall-cmd --reload

# æŸ¥çœ‹çŠ¶æ€
sudo firewall-cmd --list-ports
```

#### äº‘æœåŠ¡å•†å®‰å…¨ç»„é…ç½®
å¦‚æœä½¿ç”¨é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰äº‘æœåŠ¡å•†ï¼Œè¿˜éœ€è¦åœ¨å®‰å…¨ç»„ä¸­å¼€æ”¾ç›¸åº”ç«¯å£ï¼š

**å…¥ç«™è§„åˆ™é…ç½®**:
```
ç«¯å£èŒƒå›´    åè®®    æºIP          æè¿°
8000       TCP     0.0.0.0/0     ä¸»æœåŠ¡ç«¯å£
8083       TCP     0.0.0.0/0     ESP32éŸ³é¢‘ä¸Šä¼ 
8081       TCP     0.0.0.0/0     ASRæœåŠ¡(å¯é€‰)
8082       TCP     0.0.0.0/0     LLMæœåŠ¡(å¯é€‰)
8085       TCP     0.0.0.0/0     TTSæœåŠ¡(å¯é€‰)
8086       TCP     0.0.0.0/0     ä¸Šä¼ æœåŠ¡(å¯é€‰)
8087       TCP     0.0.0.0/0     è¾“å…¥æœåŠ¡HTTP(å¯é€‰)
```

---

## æœåŠ¡å¯åŠ¨éªŒè¯

### æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€
```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
netstat -tlnp | grep -E "(8000|8081|8082|8083|8085|8086|8087)"

# æˆ–ä½¿ç”¨sså‘½ä»¤
ss -tlnp | grep -E "(8000|8081|8082|8083|8085|8086|8087)"
```

### é¢„æœŸè¾“å‡ºç¤ºä¾‹
```
tcp    0.0.0.0:8000    0.0.0.0:*    LISTEN    1234/python (main.py)
tcp    0.0.0.0:8081    0.0.0.0:*    LISTEN    1235/python (asr_service.py)
tcp    0.0.0.0:8082    0.0.0.0:*    LISTEN    1236/python (llm_service.py)
tcp    0.0.0.0:8083    0.0.0.0:*    LISTEN    1237/python (input_service.py)
tcp    0.0.0.0:8085    0.0.0.0:*    LISTEN    1238/python (tts_service.py)
tcp    0.0.0.0:8086    0.0.0.0:*    LISTEN    1239/python (upload_service.py)
tcp    0.0.0.0:8087    0.0.0.0:*    LISTEN    1237/python (input_service.py)
```

---

## æ€»ç»“

### âœ… ç«¯å£é…ç½®æ£€æŸ¥ç»“æœ
**æ‰€æœ‰ç«¯å£é…ç½®å‡åŒ¹é…æ­£ç¡®**ï¼Œæ²¡æœ‰å‘ç°ç«¯å£å†²çªæˆ–é…ç½®é”™è¯¯ã€‚

### ğŸ”¥ é˜²ç«å¢™æœ€å°é…ç½®
**å¿…é¡»å¼€æ”¾**: 8000, 8083
**å»ºè®®å¼€æ”¾**: 8081, 8082, 8085, 8086, 8087

### ğŸ“ å»ºè®®
1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šæœ€å°åŒ–å¼€æ”¾ç«¯å£ï¼Œåªå¼€æ”¾8000å’Œ8083
2. **å¼€å‘ç¯å¢ƒ**ï¼šå»ºè®®å¼€æ”¾æ‰€æœ‰ç«¯å£ï¼Œä¾¿äºè°ƒè¯•ç›‘æ§
3. **å®‰å…¨è€ƒè™‘**ï¼šå¯ä»¥é™åˆ¶æºIPèŒƒå›´ï¼Œåªå…è®¸å·²çŸ¥IPè®¿é—®
4. **ç›‘æ§é…ç½®**ï¼šå»ºè®®é…ç½®ç«¯å£ç›‘æ§ï¼ŒåŠæ—¶å‘ç°æœåŠ¡å¼‚å¸¸

é¡¹ç›®ç«¯å£é…ç½®å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥æ­£å¸¸éƒ¨ç½²è¿è¡Œï¼
